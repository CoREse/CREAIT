<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenAI Chat</title>
<style>
    body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        background-color: #f7f7f7;
    }
    #chat-list {
        width: 250px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
    }
    #chat-list button {
        width: 100%;
        padding: 10px;
        border: none;
        background-color: #fff;
        cursor: pointer;
        text-align: left;
        outline: none;
        transition: background-color 0.3s;
    }
    #chat-list button:hover {
        background-color: #f0f0f0;
    }
    #chat-list button.current-chat {
        background-color: #e7f3ff;
        font-weight: bold;
        color: #004085;
        border-left: 4px solid #007bff;
        margin-left: -4px;
    }
    #chat-window {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    #message-panel {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
    }
    .message {
        margin-bottom: 0px;
        padding: 10px;
        border-radius: 5px;
        width: auto;
        /* min-width: 95%;
        max-width: 95%; */
    }
    .user {
        background-color: #dcf8c6;
        align-self: flex-start;
    }
    .assistant {
        background-color: #fff;
        align-self: flex-start;
    }
    .error {
        align-self: flex-start;
    }
    .entry {
        position: relative;
        display: flex;
        flex-direction: column;
        /* padding-bottom: 0.5em; */
        margin-bottom: 10px;
    }
    .usage {
        position: relative;
        /* bottom: 0;
        left: 0; */
        font-size: 0.75em;
        padding: 0px 5px;
        color: #666;
        /* background-color: rgba(255, 255, 255, 0.8); */
        border-radius: 3px;
        /* margin: 0px; */
        /* max-width: 30%; */
        /* overflow: hidden; */
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    #message-input {
        display: flex;
        padding: 10px;
        background-color: #fff;
        border-top: 1px solid #ddd;
    }
    #message-input input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        margin-right: 10px;
        border-radius: 5px;
    }
    #message-input button {
        padding: 10px 20px;
        border: none;
        background-color: #007bff;
        color: #fff;
        cursor: pointer;
        border-radius: 5px;
    }
    #settings-dialog {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    #settings-dialog input,
    #settings-dialog button {
        display: block;
        width: 100%;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    #settings-dialog button {
        background-color: #007bff;
        color: #fff;
        cursor: pointer;
    }
</style>
</head>
<body>
<div id="chat-list">
    <button onclick="newChat()">New Chat</button>
    <!-- Chat list will be dynamically inserted here -->
</div>
<div id="chat-window">
    <div id="message-panel">
        <!-- Messages will be dynamically inserted here -->
    </div>
    <div id="message-input">
        <input type="text" id="message-text" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>
<div id="settings-dialog">
    <p>API URL: <input type="text" id="api-url"></p>
    <p>API key: <input type="text" id="api-key"></p>
    <p>Default model: <input type="text" id="default-model"></p>
    <p>Max context number (exclude current message): <input type="number" id="context-number"></p>
    <p>Max context tokens (exclude current message): <input type="number" id="context-tokens"></p>
    <button onclick="saveSettings()">Save Settings</button>
    <button onclick="closeSettings()">Close</button>
</div>
<script>
    let currentChatId = null;
    let chats = {};
    let settings = {
        apiKey: '',
        defaultModel: 'gpt-3.5-turbo-1106',
        apiUrl: 'https://api.openai.com',
        contextNumber:5,
        contextTokens:8192
    };

    // Load settings and chats from local storage
    window.onload = function() {
        loadSettings();
        loadChats();
        renderChats();
    };

    function loadSettings() {
        const savedSettings = localStorage.getItem('settings');
        if (savedSettings) {
            savedSettingsObj = JSON.parse(savedSettings);
            for (const key in savedSettingsObj) {
                if (key in settings) {
                    settings[key]=savedSettingsObj[key];
                }
            }
        }
    }

    function loadChats() {
        const savedChats = localStorage.getItem('chats');
        if (savedChats) {
            chats = JSON.parse(savedChats);
        }
        if (Object.keys(chats).length!=0)
        {
            currentChatId=Object.keys(chats)[0];
        }
    }

    function renderChats() {
        const chatList = document.getElementById('chat-list');
        chatList.innerHTML = '<button onclick="newChat()">New Chat</button>';
        Object.keys(chats).forEach(chatId => {
            const button = document.createElement('button');
            if (chatId==currentChatId) button.classList.add("current-chat");
            button.textContent = `Chat ${chatId}`;
            button.onclick = () => switchChat(chatId);
            chatList.appendChild(button);
        });
        if (currentChatId!=null)
        {
            renderMessages(chats[currentChatId]);
        }
    }

    function switchChat(chatId) {
        currentChatId = chatId;
        renderChats();
        renderMessages(chats[chatId]);
    }

    function renderMessages(messages) {
        const messagePanel = document.getElementById('message-panel');
        messagePanel.innerHTML = '';
        messages.forEach(message => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(message.message.role);
            messageDiv.innerHTML = message.message.content;
            const entryDiv=document.createElement('div');
            entryDiv.classList.add('entry')
            entryDiv.innerHTML=message.message.role
            entryDiv.appendChild(messageDiv)
            let usageString=""
            if (message.usage)
            {
                usageString+=`Token usage: ${message.usage.prompt_tokens} prompt, ${message.usage.completion_tokens} completion, ${message.usage.total_tokens} total.`
            }
            if (message.messageTokens)
            {
                if (usageString!="") usageString+=" ";
                usageString+=`Message tokens: ${message.messageTokens}.`
            }
            if (usageString!="")
            {
                const usageDiv=document.createElement("div");
                usageDiv.innerHTML=usageString;
                usageDiv.classList.add("usage");
                entryDiv.appendChild(usageDiv);
            }
            messagePanel.appendChild(entryDiv);
        });
        messagePanel.scrollTop = messagePanel.scrollHeight;
    }

    function newChat() {
        const chatId = Date.now().toString();
        chats[chatId] = [];
        currentChatId = chatId;
        renderChats();
        renderMessages([]);
    }

    function sendMessage() {
        const input = document.getElementById('message-text');
        const message = input.value.trim();
        if (message === '') return;
        packedMessage = {message:{role: "user", content:message}, fulfilled: false}
        addMessage(packedMessage);
        const chatID=currentChatId;
        input.value = '';
        callOpenAI(chatID,chats[chatID].length-1);
    }

    function addMessage(message) {
        if (!currentChatId) return;
        chats[currentChatId].push(message);
        saveChats();
        renderMessages(chats[currentChatId]);
    }

    function saveChats() {
        localStorage.setItem('chats', JSON.stringify(chats));
    }

    function getContext(messages,index) {
        // console.log(messages)
        let context=[];
        if (settings.contextNumber!=0) context = messages.slice(0,index).filter((m)=>(m.message.role!="error" && (m.hasOwnProperty("fulfilled")?m.fulfilled:true))).slice(-settings.contextNumber);
        // for (let i = index - settings.contextNumber; i <= index; i++) {
        //     if (i < 0) continue;
        //     const message = messages[i];
        //     if (message.message.role === 'user') continue;
        //     context.push(message.message.content);
        // }
        const contextMessage=[];
        let messageTokens=0;
        const reversedContext=context.reverse()
        for (m of reversedContext)
        {
            if (messageTokens+m.messageTokens<=settings.contextTokens)
            {
                contextMessage.unshift(m.message);
                messageTokens+=m.messageTokens;
            }
            else
            {
                break;
            }
        }
        contextMessage.push(messages[index].message)
        return {messages:contextMessage,tokens:messageTokens};
    }

    function callOpenAI(chatID,index) {
        const context=getContext(chats[chatID],index);
        console.log(context)
        const data = {
            model: settings.defaultModel,
            messages: context.messages
        };

        fetch(settings.apiUrl+'/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${settings.apiKey}`
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log(data)
            const aiMessage = data.choices[0].message;
            const responseUsage=data.usage;
            chats[chatID][index].fulfilled=true;
            chats[chatID][index].messageTokens=responseUsage.prompt_tokens-context.tokens;
            addMessage({message:aiMessage, usage:responseUsage, messageTokens:responseUsage.completion_tokens});
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage({message:{role:"error", content:'OpenAI: Error communicating with the API.'}});
        });
    }

    function openSettings() {
        document.getElementById('settings-dialog').style.display = 'block';
        document.getElementById('api-key').value = settings.apiKey;
        document.getElementById('default-model').value = settings.defaultModel;
        document.getElementById('api-url').value = settings.apiUrl;
        document.getElementById('context-number').value = settings.contextNumber;
        document.getElementById('context-tokens').value = settings.contextTokens;
    }

    function saveSettings() {
        settings.apiKey = document.getElementById('api-key').value.trim();
        settings.defaultModel = document.getElementById('default-model').value.trim();
        settings.apiUrl = document.getElementById('api-url').value.trim();
        settings.contextNumber=document.getElementById('context-number').value.trim();
        localStorage.setItem('settings', JSON.stringify(settings));
        closeSettings();
    }

    function closeSettings() {
        document.getElementById('settings-dialog').style.display = 'none';
    }

    // Add settings button
    const settingsButton = document.createElement('button');
    settingsButton.textContent = 'Settings';
    settingsButton.style.position = 'absolute';
    settingsButton.style.top = '10px';
    settingsButton.style.right = '10px';
    settingsButton.onclick = openSettings;
    document.body.appendChild(settingsButton);
</script>
</body>
</html>
